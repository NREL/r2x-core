<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html"><link rel="next" title="Plugin Context" href="plugin-context.html"><link rel="prev" title="Create Power System Components with Units" href="working-with-units.html">

    <!-- Generated with Sphinx 7.4.7 and Furo 2025.12.19 -->
        <title>Plugin System - r2x-core</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-reports.e44b1595f1e09d5e109d001839ba3f42.css?v=0b41afa8" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=48ff25d5" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     
        <strong>ðŸŽ‰ R2X Core v1.0.0 is now available!</strong>
        This is our first Long-Term Support (LTS) release.
        <a href="https://github.com/NREL/r2x-core/releases/tag/v0.1.0" target="_blank">View release notes</a>
     
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">r2x-core</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <span class="sidebar-brand-text">r2x-core</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input aria-label="Toggle navigation of Tutorials" checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting-started.html">Getting Started with R2X Core</a></li>
<li class="toctree-l2"><a class="reference internal" href="working-with-units.html">Create Power System Components with Units</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Plugin System</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin-context.html">Plugin Context</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin-discovery.html">Plugin Discovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin-utilities.html">Plugin Developer Utilities</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../how-tos/index.html">How-To Guides</a><input aria-label="Toggle navigation of How-To Guides" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/configure-data-settings.html">Configuring Data Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/configure-data-files.html">Working with DataFiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/read-data-files.html">Read Data Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/read-hdf5-files.html">Reading HDF5 Data Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/manage-datastores.html">Managing Datastores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/process-file-data.html">Processing File Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/convert-units.html">Work with Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/manage-systems.html">Managing Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/attach-timeseries.html">Attaching Time Series</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/build-parsers.html">Parser Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/build-exporters.html">Exporter Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/create-function-plugins.html">Create Function-Based Transform Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/structure-plugin-directories.html">Plugin Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/register-plugins.html">Create and Register Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/run-plugins.html">Using Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/define-rule-mappings.html">Working with Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/create-rules.html">Create Translation Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/apply-rules.html">Apply Translation Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/create-rule-filters.html">Rule Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/manage-versions.html">Managing Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/upgrade-data-files.html">Upgrade Data Between Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-tos/upgrade-systems.html">Upgrade Systems Between Versions</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../explanations/index.html">Explanations</a><input aria-label="Toggle navigation of Explanations" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../explanations/plugin-system.html">Plugin System Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/unit-system.html">Unit System Design and Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/h5-readers.html">HDF5 Reader System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/rules-system.html">Rule System Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/data-management.html">Data Management: Design Philosophy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/versioning.html">Versioning and Upgrades: Design Philosophy</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../references/index.html">Reference</a><input aria-label="Toggle navigation of Reference" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../references/api.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/system.html">System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/units.html">Units Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/parser.html">Parser Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/exporter.html">Exporter Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/plugins.html">Plugin System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/versioning.html">Versioning Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/upgrader.html">Upgrade System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/processors.html">Data Processors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/utils.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/exceptions.html">Exceptions Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/file-formats.html">File Formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/file-types.html">File Types API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/models.html">Data Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../references/results.html">Results</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/NREL/r2x-core/blob/main/docs/source/tutorials/plugin-system.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/NREL/r2x-core/edit/main/docs/source/tutorials/plugin-system.md" rel="edit" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="plugin-system">
<h1>Plugin System<a class="headerlink" href="#plugin-system" title="Link to this heading">Â¶</a></h1>
<p>The r2x plugin system uses a capability-based design where plugins implement only the hooks
they need. The plugin lifecycle runs hooks in a fixed order, skipping any that arenâ€™t
implemented. This approach provides remarkable flexibility because plugins do only what they
needâ€”whether thatâ€™s building systems from scratch, transforming existing systems,
translating between formats, or exporting results.</p>
<p>Required context fields are declared through type hints on properties, making it immediately
clear what each plugin needs to function. The ast-grep tool can automatically extract plugin
config types and their capabilities by analyzing the plugin structure, enabling discovery and
documentation generation. The generic <code class="docutils literal notranslate"><span class="pre">Plugin[ConfigT]</span></code> class provides type-safe access to
configuration, catching configuration errors at runtime through Pydantic validation.</p>
<section id="creating-a-simple-plugin">
<h2>Creating a Simple Plugin<a class="headerlink" href="#creating-a-simple-plugin" title="Link to this heading">Â¶</a></h2>
<p>Plugins inherit from <code class="docutils literal notranslate"><span class="pre">Plugin[ConfigT]</span></code> where <code class="docutils literal notranslate"><span class="pre">ConfigT</span></code> is your configuration class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Plugin</span><span class="p">,</span> <span class="n">PluginContext</span><span class="p">,</span> <span class="n">PluginConfig</span><span class="p">,</span> <span class="n">System</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rust_ok</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ok</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyConfig</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyPlugin</span><span class="p">(</span><span class="n">Plugin</span><span class="p">[</span><span class="n">MyConfig</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># Create context and run</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="n">PluginContext</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">MyConfig</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">))</span>
<span class="n">plugin</span> <span class="o">=</span> <span class="n">MyPlugin</span><span class="o">.</span><span class="n">from_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">result_ctx</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">result_ctx</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;test&#39;</span>
</pre></div>
</div>
</section>
<section id="plugin-lifecycle">
<h2>Plugin Lifecycle<a class="headerlink" href="#plugin-lifecycle" title="Link to this heading">Â¶</a></h2>
<p>The plugin lifecycle consists of seven optional hooks, called in this fixed order:</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Hook</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">on_validate()</span></code></p></td>
<td><p>Validate inputs and configuration</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">on_prepare()</span></code></p></td>
<td><p>Load data, setup resources</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">on_build()</span></code></p></td>
<td><p>Create a new system from scratch</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">on_transform()</span></code></p></td>
<td><p>Modify an existing system in-place</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">on_translate()</span></code></p></td>
<td><p>Convert source system to target system</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">on_export()</span></code></p></td>
<td><p>Write system to files</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">on_cleanup()</span></code></p></td>
<td><p>Cleanup resources</p></td>
</tr>
</tbody>
</table>
</div>
<pre  class="mermaid">
        flowchart TD
    Start([Start]) --&gt; Validate[on_validate]
    Validate --&gt; Prepare[on_prepare]
    Prepare --&gt; Build[on_build]
    Build --&gt; Transform[on_transform]
    Transform --&gt; Translate[on_translate]
    Translate --&gt; Export[on_export]
    Export --&gt; Cleanup[on_cleanup]
    </pre><p>Each hook returns <code class="docutils literal notranslate"><span class="pre">Result[None</span> <span class="pre">|</span> <span class="pre">System,</span> <span class="pre">Exception]</span></code>. If any hook returns an error, execution stops and a <code class="docutils literal notranslate"><span class="pre">PluginError</span></code> is raised.</p>
<section id="complete-lifecycle-example">
<h3>Complete Lifecycle Example<a class="headerlink" href="#complete-lifecycle-example" title="Link to this heading">Â¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Plugin</span><span class="p">,</span> <span class="n">PluginContext</span><span class="p">,</span> <span class="n">PluginConfig</span><span class="p">,</span> <span class="n">System</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rust_ok</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ok</span><span class="p">,</span> <span class="n">Err</span><span class="p">,</span> <span class="n">Result</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FullConfig</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="n">input_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">scale_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/tmp&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FullPlugin</span><span class="p">(</span><span class="n">Plugin</span><span class="p">[</span><span class="n">FullConfig</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scale_factor must be positive&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">]:</span>
        <span class="c1"># Load data, setup</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">System</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">]:</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">input_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">System</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">]:</span>
        <span class="c1"># Modify system</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
<span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="n">PluginContext</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">FullConfig</span><span class="p">(</span><span class="n">input_name</span><span class="o">=</span><span class="s2">&quot;example&quot;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">))</span>
<span class="n">plugin</span> <span class="o">=</span> <span class="n">FullPlugin</span><span class="o">.</span><span class="n">from_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;example&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="required-vs-optional-context-fields">
<h2>Required vs Optional Context Fields<a class="headerlink" href="#required-vs-optional-context-fields" title="Link to this heading">Â¶</a></h2>
<p>Plugins indicate which context fields they need via <strong>property return types</strong>:</p>
<ul class="simple">
<li><p><strong>Non-Optional return type</strong> (e.g., <code class="docutils literal notranslate"><span class="pre">-&gt;</span> <span class="pre">System</span></code>) = <strong>required</strong> - raises <code class="docutils literal notranslate"><span class="pre">PluginError</span></code> if missing</p></li>
<li><p><strong>Optional return type</strong> (e.g., <code class="docutils literal notranslate"><span class="pre">-&gt;</span> <span class="pre">System</span> <span class="pre">|</span> <span class="pre">None</span></code>) = <strong>optional</strong> - returns None if missing</p></li>
</ul>
<section id="example-parser-requires-config-store">
<h3>Example: Parser (Requires config, store)<a class="headerlink" href="#example-parser-requires-config-store" title="Link to this heading">Â¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Plugin</span><span class="p">,</span> <span class="n">PluginContext</span><span class="p">,</span> <span class="n">PluginConfig</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">DataStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rust_ok</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ok</span><span class="p">,</span> <span class="n">Result</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ParserConfig</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="n">input_file</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SimpleParser</span><span class="p">(</span><span class="n">Plugin</span><span class="p">[</span><span class="n">ParserConfig</span><span class="p">]):</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataStore</span><span class="p">:</span>  <span class="c1"># Non-Optional = required</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="n">store</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;DataStore required for parsing&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="n">store</span>
<span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">System</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">]:</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;parsed_system&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>

<span class="n">store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="p">()</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="n">PluginContext</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">ParserConfig</span><span class="p">(</span><span class="n">input_file</span><span class="o">=</span><span class="s2">&quot;data.csv&quot;</span><span class="p">),</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">SimpleParser</span><span class="o">.</span><span class="n">from_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;parsed_system&#39;</span>
</pre></div>
</div>
</section>
<section id="example-exporter-requires-config-system-store">
<h3>Example: Exporter (Requires config, system, store)<a class="headerlink" href="#example-exporter-requires-config-system-store" title="Link to this heading">Â¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Plugin</span><span class="p">,</span> <span class="n">PluginContext</span><span class="p">,</span> <span class="n">PluginConfig</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">DataStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rust_ok</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ok</span><span class="p">,</span> <span class="n">Result</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ExporterConfig</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SimpleExporter</span><span class="p">(</span><span class="n">Plugin</span><span class="p">[</span><span class="n">ExporterConfig</span><span class="p">]):</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">:</span>  <span class="c1"># Non-Optional = required</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="n">system</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;System required for export&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="n">system</span>
<span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_export</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">]:</span>
        <span class="c1"># Export system to files</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;my_system&quot;</span><span class="p">)</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="p">()</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="n">PluginContext</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">ExporterConfig</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;/tmp&quot;</span><span class="p">),</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>
<span class="n">exporter</span> <span class="o">=</span> <span class="n">SimpleExporter</span><span class="o">.</span><span class="n">from_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;my_system&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="plugin-capabilities-inferred-from-hooks">
<h2>Plugin Capabilities (Inferred from Hooks)<a class="headerlink" href="#plugin-capabilities-inferred-from-hooks" title="Link to this heading">Â¶</a></h2>
<p>Plugin capabilities are automatically inferred from which hooks are implemented. A build
plugin implements <code class="docutils literal notranslate"><span class="pre">on_build()</span></code> to create systems from data. A transform plugin implements
<code class="docutils literal notranslate"><span class="pre">on_transform()</span></code> to modify existing systems in-place. A translate plugin implements
<code class="docutils literal notranslate"><span class="pre">on_translate()</span></code> to convert from a source system format to a target system format. An export
plugin implements <code class="docutils literal notranslate"><span class="pre">on_export()</span></code> to write systems to files in various formats. More complex
workflows combine multiple capabilitiesâ€”a plugin can both translate and export, or validate
and transform, depending on what the workflow requires.</p>
<section id="example-multi-capability-plugin">
<h3>Example: Multi-Capability Plugin<a class="headerlink" href="#example-multi-capability-plugin" title="Link to this heading">Â¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Plugin</span><span class="p">,</span> <span class="n">PluginContext</span><span class="p">,</span> <span class="n">PluginConfig</span><span class="p">,</span> <span class="n">System</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rust_ok</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ok</span><span class="p">,</span> <span class="n">Result</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TranslateExportConfig</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Plexos2SiennaExporter</span><span class="p">(</span><span class="n">Plugin</span><span class="p">[</span><span class="n">TranslateExportConfig</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_translate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">System</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">]:</span>
        <span class="c1"># Create target system from source</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sienna_system&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_export</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">]:</span>
        <span class="c1"># Also export the result</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="n">source</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;plexos_system&quot;</span><span class="p">)</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="n">PluginContext</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">TranslateExportConfig</span><span class="p">(),</span> <span class="n">source_system</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
<span class="n">plugin</span> <span class="o">=</span> <span class="n">Plexos2SiennaExporter</span><span class="o">.</span><span class="n">from_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">target_system</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;sienna_system&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="configuration-with-type-safety">
<h2>Configuration with Type Safety<a class="headerlink" href="#configuration-with-type-safety" title="Link to this heading">Â¶</a></h2>
<p>Plugin config types are extracted via generics, enabling type-safe access to plugin-specific
fields. The ast-grep discovery tool can automatically analyze plugin classes to extract config
schemas. Automatic validation happens through Pydantic, catching configuration errors before
plugins execute.</p>
<p>Config fields can be either required or optional. Fields without defaults are required and
must be provided when instantiating the config. Fields with defaults are optional and will
use their default values if not provided:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">PluginConfig</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FullConfig</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="n">model_year</span><span class="p">:</span> <span class="nb">int</span>              <span class="c1"># Required - no default</span>
    <span class="n">input_folder</span><span class="p">:</span> <span class="nb">str</span>            <span class="c1"># Required - no default</span>
    <span class="n">scenario</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;base&quot;</span>       <span class="c1"># Optional - has default</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>        <span class="c1"># Optional - has default</span>

<span class="c1"># Valid: provides all required fields</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">FullConfig</span><span class="p">(</span><span class="n">model_year</span><span class="o">=</span><span class="mi">2030</span><span class="p">,</span> <span class="n">input_folder</span><span class="o">=</span><span class="s2">&quot;/data&quot;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">scenario</span>
<span class="s1">&#39;base&#39;</span>

<span class="c1"># Invalid: missing required field</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">bad_cfg</span> <span class="o">=</span> <span class="n">FullConfig</span><span class="p">(</span><span class="n">model_year</span><span class="o">=</span><span class="mi">2030</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="s2">&quot;input_folder&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="kc">True</span>
</pre></div>
</div>
<p>Pydantic validates all fields during instantiation, so configuration errors are caught
immediately rather than later during plugin execution when they would be harder to debug.</p>
</section>
<section id="plugin-discovery">
<h2>Plugin Discovery<a class="headerlink" href="#plugin-discovery" title="Link to this heading">Â¶</a></h2>
<p>Plugins are discovered through entry points registered in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>. The discovery
process reads the config type from the generic parameter (e.g., <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">MyPlugin(Plugin[MyConfig])</span></code>),
determining what configuration the plugin accepts. It identifies implemented hooks by scanning
for method names like <code class="docutils literal notranslate"><span class="pre">on_validate</span></code>, <code class="docutils literal notranslate"><span class="pre">on_build</span></code>, <code class="docutils literal notranslate"><span class="pre">on_transform</span></code>, <code class="docutils literal notranslate"><span class="pre">on_translate</span></code>, <code class="docutils literal notranslate"><span class="pre">on_export</span></code>,
and <code class="docutils literal notranslate"><span class="pre">on_cleanup</span></code>. Required context fields are inferred from non-Optional property return typesâ€”a
property returning <code class="docutils literal notranslate"><span class="pre">System</span></code> requires a system, while <code class="docutils literal notranslate"><span class="pre">System</span> <span class="pre">|</span> <span class="pre">None</span></code> makes it optional. The
config schema is extracted directly from Pydantic field definitions, enabling full documentation
generation without parsing the plugin code.</p>
<p>Plugins are registered as entry points in external packages:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[project.entry-points.</span><span class="s2">&quot;r2x.plugins&quot;</span><span class="k">]</span>
<span class="n">my_model_parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;my_package.plugins:MyModelPlugin&quot;</span>
</pre></div>
</div>
</section>
<section id="passing-context-through-pipelines">
<h2>Passing Context Through Pipelines<a class="headerlink" href="#passing-context-through-pipelines" title="Link to this heading">Â¶</a></h2>
<p>Use the <code class="docutils literal notranslate"><span class="pre">evolve()</span></code> method for memory-efficient context updates:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Plugin</span><span class="p">,</span> <span class="n">PluginContext</span><span class="p">,</span> <span class="n">PluginConfig</span><span class="p">,</span> <span class="n">System</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rust_ok</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ok</span><span class="p">,</span> <span class="n">Result</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># Build a system</span>
<span class="n">build_ctx</span> <span class="o">=</span> <span class="n">PluginContext</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">())</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;built&quot;</span><span class="p">)</span>

<span class="c1"># Pass to next step</span>
<span class="n">transform_ctx</span> <span class="o">=</span> <span class="n">build_ctx</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>
<span class="n">transform_ctx</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;built&#39;</span>

<span class="c1"># Continue pipeline</span>
<span class="n">export_ctx</span> <span class="o">=</span> <span class="n">transform_ctx</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;exported&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">export_ctx</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;built&#39;</span>
<span class="n">export_ctx</span><span class="o">.</span><span class="n">metadata</span>
<span class="p">{</span><span class="s1">&#39;exported&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="error-handling">
<h2>Error Handling<a class="headerlink" href="#error-handling" title="Link to this heading">Â¶</a></h2>
<p>Plugins use <code class="docutils literal notranslate"><span class="pre">Result[T,</span> <span class="pre">E]</span></code> for error handling. If any hook returns <code class="docutils literal notranslate"><span class="pre">Err</span></code>, execution stops:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Plugin</span><span class="p">,</span> <span class="n">PluginContext</span><span class="p">,</span> <span class="n">PluginConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rust_ok</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ok</span><span class="p">,</span> <span class="n">Err</span><span class="p">,</span> <span class="n">Result</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FailConfig</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="n">should_fail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FailPlugin</span><span class="p">(</span><span class="n">Plugin</span><span class="p">[</span><span class="n">FailConfig</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">should_fail</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Validation failed!&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Success case</span>
<span class="n">ctx1</span> <span class="o">=</span> <span class="n">PluginContext</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">FailConfig</span><span class="p">(</span><span class="n">should_fail</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">result1</span> <span class="o">=</span> <span class="n">FailPlugin</span><span class="o">.</span><span class="n">from_context</span><span class="p">(</span><span class="n">ctx1</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">result1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="kc">True</span>

<span class="c1"># Failure case</span>
<span class="n">ctx2</span> <span class="o">=</span> <span class="n">PluginContext</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">FailConfig</span><span class="p">(</span><span class="n">should_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FailPlugin</span><span class="o">.</span><span class="n">from_context</span><span class="p">(</span><span class="n">ctx2</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="s2">&quot;Validation failed&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="kc">True</span>
</pre></div>
</div>
</section>
<section id="introspection-for-plugin-discovery">
<h2>Introspection for Plugin Discovery<a class="headerlink" href="#introspection-for-plugin-discovery" title="Link to this heading">Â¶</a></h2>
<p>Extract plugin metadata programmatically:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Plugin</span><span class="p">,</span> <span class="n">PluginConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rust_ok</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ok</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyConfig</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyPlugin</span><span class="p">(</span><span class="n">Plugin</span><span class="p">[</span><span class="n">MyConfig</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Get config type</span>
<span class="n">MyPlugin</span><span class="o">.</span><span class="n">get_config_type</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span>
<span class="s1">&#39;MyConfig&#39;</span>

<span class="c1"># Get implemented hooks</span>
<span class="nb">sorted</span><span class="p">(</span><span class="n">MyPlugin</span><span class="o">.</span><span class="n">get_implemented_hooks</span><span class="p">())</span>
<span class="p">[</span><span class="s1">&#39;on_build&#39;</span><span class="p">,</span> <span class="s1">&#39;on_validate&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">Â¶</a></h2>
<p>When designing plugins, implement only the hooks you actually need. Adding unnecessary hooks
creates complexity and makes testing harder. Use type hints on context properties to clearly
indicate what each plugin requiresâ€”this makes dependencies explicit and enables the discovery
system to work properly.</p>
<p>Validate configuration and inputs early in the <code class="docutils literal notranslate"><span class="pre">on_validate()</span></code> hook before any expensive
operations. This catches errors immediately rather than failing partway through a long
computation. Use the <code class="docutils literal notranslate"><span class="pre">on_cleanup()</span></code> hook to properly release resources like database
connections, file handles, or temporary files, ensuring clean shutdown even if errors occur.</p>
<p>When chaining plugins together in pipelines, use the <code class="docutils literal notranslate"><span class="pre">evolve()</span></code> method to efficiently pass
context forward. This is more memory-efficient than creating new contexts from scratch.
Return specific exception types rather than generic <code class="docutils literal notranslate"><span class="pre">Exception</span></code> so callers can handle
different error conditions appropriately. Finally, add docstrings to config classes to help
with discoverability and so the discovery system can extract meaningful documentation about
what configuration each plugin accepts.</p>
</section>
<section id="function-based-transform-plugins">
<h2>Function-Based Transform Plugins<a class="headerlink" href="#function-based-transform-plugins" title="Link to this heading">Â¶</a></h2>
<p>For simple System transformations, you can use function-based plugins with the <code class="docutils literal notranslate"><span class="pre">&#64;expose_plugin</span></code> decorator.
These are zero-overhead alternatives to the full Plugin class pattern:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">r2x_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">expose_plugin</span><span class="p">,</span> <span class="n">PluginConfig</span><span class="p">,</span> <span class="n">System</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rust_ok</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ok</span><span class="p">,</span> <span class="n">Result</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyTransformConfig</span><span class="p">(</span><span class="n">PluginConfig</span><span class="p">):</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>

<span class="nd">@expose_plugin</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_transform</span><span class="p">(</span><span class="n">system</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">MyTransformConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">System</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform system based on config.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># Call directly in Python:</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">MyTransformConfig</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">my_transform</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p>Function-based plugins:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">PluginConfig</span></code> for type-safe configuration</p></li>
<li><p>Return <code class="docutils literal notranslate"><span class="pre">Result[System,</span> <span class="pre">str]</span></code> for consistent error handling</p></li>
<li><p>Are marked with <code class="docutils literal notranslate"><span class="pre">&#64;expose_plugin</span></code> for CLI discovery via entry points</p></li>
<li><p>Are called explicitly with all arguments (no auto-injection)</p></li>
</ul>
<p>See <a class="reference internal" href="../how-tos/create-function-plugins.html"><span class="doc">Create Function-Based Transform Plugins</span></a> for detailed examples and best practices.</p>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">Â¶</a></h2>
<p>For working with function-based plugins, see <a class="reference internal" href="../how-tos/create-function-plugins.html"><span class="doc">Create Function-Based Transform Plugins</span></a>. For
detailed patterns on how to use plugin context effectively in complex workflows with class-based
plugins, see <a class="reference internal" href="plugin-context.html"><span class="doc">Plugin Context</span></a>. Additional examples of working plugins can be found in
<code class="docutils literal notranslate"><span class="pre">tests/test_plugin*.py</span></code>, covering edge cases and advanced patterns not shown in this introduction.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="plugin-context.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Plugin Context</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="working-with-units.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Create Power System Components with Units</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Alliance for Sustainable Energy LLC, All rights reserved.
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/NREL/r2x-core" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Plugin System</a><ul>
<li><a class="reference internal" href="#creating-a-simple-plugin">Creating a Simple Plugin</a></li>
<li><a class="reference internal" href="#plugin-lifecycle">Plugin Lifecycle</a><ul>
<li><a class="reference internal" href="#complete-lifecycle-example">Complete Lifecycle Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#required-vs-optional-context-fields">Required vs Optional Context Fields</a><ul>
<li><a class="reference internal" href="#example-parser-requires-config-store">Example: Parser (Requires config, store)</a></li>
<li><a class="reference internal" href="#example-exporter-requires-config-system-store">Example: Exporter (Requires config, system, store)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plugin-capabilities-inferred-from-hooks">Plugin Capabilities (Inferred from Hooks)</a><ul>
<li><a class="reference internal" href="#example-multi-capability-plugin">Example: Multi-Capability Plugin</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration-with-type-safety">Configuration with Type Safety</a></li>
<li><a class="reference internal" href="#plugin-discovery">Plugin Discovery</a></li>
<li><a class="reference internal" href="#passing-context-through-pipelines">Passing Context Through Pipelines</a></li>
<li><a class="reference internal" href="#error-handling">Error Handling</a></li>
<li><a class="reference internal" href="#introspection-for-plugin-discovery">Introspection for Plugin Discovery</a></li>
<li><a class="reference internal" href="#best-practices">Best Practices</a></li>
<li><a class="reference internal" href="#function-based-transform-plugins">Function-Based Transform Plugins</a></li>
<li><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=9dc614e0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=3a0c56fd"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";





const initStyles = () => {
    const defaultStyle = document.createElement('style');
    defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}`;
    document.head.appendChild(defaultStyle);

    const fullscreenStyle = document.createElement('style');
    fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
    document.head.appendChild(fullscreenStyle);
}

// Detect if page has dark background
const isDarkTheme = () => {
    // We use a set of heuristics:
    // 1. Check for common dark mode classes or attributes
    // 2. Check computed background color brightness
    if (document.documentElement.classList.contains('dark') ||
        document.documentElement.getAttribute('data-theme') === 'dark' ||
        document.body.classList.contains('dark') ||
        document.body.getAttribute('data-theme') === 'dark') {
        // console.log("Dark theme detected via class/attribute");
        return true;
    }
    if (document.documentElement.classList.contains('light') ||
        document.documentElement.getAttribute('data-theme') === 'light' ||
        document.body.classList.contains('light') ||
        document.body.getAttribute('data-theme') === 'light') {
        // console.log("Light theme detected via class/attribute");
        return false;
    }
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        // console.log("Dark theme detected via prefers-color-scheme");
        return true;
    }
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        // console.log("Background color brightness:", brightness);
        return brightness < 128;
    }
    // console.log("No dark or light theme detected, defaulting to light theme");
    return false;
};

let darkTheme = isDarkTheme();
let modal = null;
let modalContent = null;
let previousScrollOffset = [window.scrollX, window.scrollY];

const runMermaid = async (rerun) => {
    console.log("Running mermaid diagrams, rerun =", rerun);
    // clear all existing mermaid charts
    let all_mermaids = document.querySelectorAll(".mermaid");

    if (rerun) {
        all_mermaids.forEach((el) => {
            if(!el.hasAttribute("data-original-code")) {
                // store original code
                // console.log(`Storing original code for first run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
            if(el.getAttribute("data-processed") === "true") {
                // remove and restore original
                el.removeAttribute("data-processed");
                // console.log(`Restoring original code for re-run: `, el.getAttribute('data-original-code'));
                el.innerHTML = el.getAttribute('data-original-code');
            } else {
                // store original code
                // console.log(`Storing original code for re-run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
        });
        await mermaid.run();
    }

    all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(() => runMermaid(false), 200);
        return;
    }

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    if (modal !== null ) {
        // Destroy existing modal
        modal.remove();
        modal = null;
        modalContent = null;
    }

    modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">âœ•</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            // Already processed, adjust button class if needed
            const existingBtn = mermaidDiv.parentNode.querySelector('.mermaid-fullscreen-btn');
            if (existingBtn) {
                existingBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
            }
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = 'â›¶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        container.appendChild(fullscreenBtn);
    });
};

const load = async () => {
    initStyles();

    await runMermaid(true);

    const reRunIfThemeChanges = async () => {
        const newDarkTheme = isDarkTheme();
        if (newDarkTheme !== darkTheme) {
            darkTheme = newDarkTheme;
            console.log("Theme change detected, re-running mermaid with", darkTheme ? "dark" : "default", "theme");
            await mermaid.initialize(
                {...JSON.parse(
                    `{"startOnLoad": false}`
                ),
                ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
                }
            );
            await runMermaid(true);
        }
    };

    // Update theme classes when theme changes
    const themeObserver = new MutationObserver(reRunIfThemeChanges);
    themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    themeObserver.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
};





console.log("Initializing mermaid with", darkTheme ? "dark" : "default", "theme");
mermaid.initialize(
    {...JSON.parse(
        `{"startOnLoad": false}`
    ),
    ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
    }
);

window.addEventListener("load", load);</script>
    <script src="../_static/custom.js?v=40245e7d"></script>
    </body>
</html>